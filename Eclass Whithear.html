<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Class</title>
  <style>
    table { width: 100%; border-collapse: collapse; }
    table, th, td { border: 1px solid black; }
    th, td { padding: 8px; text-align: left; }
    .details-row { display: none; background-color: #f9f9f9; }
    .show-hide-btn { cursor: pointer; color: blue; text-decoration: underline; background: transparent; border: none; }
  </style>
</head>
<body>

<h2 id="pageTitle">Google Sheets Data</h2>

<table id="dataTable">
  <thead></thead>
  <tbody></tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Get URL params (support the misspelling + correct spelling)
  const urlParams = new URLSearchParams(window.location.search);
  const classSeperator = (urlParams.get('Class_Seperator') || urlParams.get('Class_Separator') || '').trim();
  const backColor        = urlParams.get('Back_Color');
  const tableHeaderColor = urlParams.get('Table_Header');
  const tableRowColor    = urlParams.get('Table_Row');

  // Theme
  if (backColor && /^#[0-9A-Fa-f]{6}$/.test(backColor)) {
    document.body.style.backgroundColor = backColor;
  }

  // Set page title and heading from Class_Seperator
  const h2 = document.getElementById('pageTitle');
  if (classSeperator) {
    document.title = `Daily Class – ${classSeperator}`;
    if (h2) h2.textContent = `Google Sheets Data – ${classSeperator}`;
  } else {
    console.error("No Class_Seperator/Class_Separator parameter in URL.");
    if (h2) h2.textContent = 'Google Sheets Data – (no class selected)';
    return; // Stop if no class provided
  }

  const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpZrnrbqmMAZqqTFre3fgoZa73ZiYj7XhJzNXSHYhyXIVQb-WjCJfY2K25Rxm28U7JuCdXTbOOOLXy/pub?output=csv';

  // Optional proxy (usually not needed for published Google Sheets)
  const proxyUrl = ''; 
  const finalUrl = proxyUrl + sheetUrl;

  fetch(finalUrl)
    .then(response => response.text())
    .then(text => {
      // Normalize line endings and split
      const rows = text.replace(/\r/g, '').split('\n').filter(r => r.trim().length > 0);
      if (rows.length === 0) return;

      const tableBody = document.querySelector("#dataTable tbody");
      const tableHeader = document.querySelector("#dataTable thead");

      // Build header (skip columns 3 (index 2) and 9 (index 8))
      const headerCells = rows[0].split(',');
      let headerRow = tableHeader.insertRow();
      let renderedHeaderCount = 0;
      headerCells.forEach((cell, index) => {
        if (index !== 2 && index !== 8) {
          let newHeaderCell = headerRow.insertCell();
          newHeaderCell.textContent = cell || '';
          if (tableHeaderColor && /^#[0-9A-Fa-f]{6}$/.test(tableHeaderColor)) {
            newHeaderCell.style.backgroundColor = tableHeaderColor;
          }
          renderedHeaderCount++;
        }
      });

      // We'll add one more column for the Show/Hide Details button
      const actionsHeader = headerRow.insertCell();
      actionsHeader.textContent = 'Actions';
      if (tableHeaderColor && /^#[0-9A-Fa-f]{6}$/.test(tableHeaderColor)) {
        actionsHeader.style.backgroundColor = tableHeaderColor;
      }
      renderedHeaderCount++; // count the actions column too

      // Collect filtered rows
      let tableRows = [];
      rows.slice(1).forEach(row => {
        const cells = row.split(',');
        if (cells.length > 1) {
          // Match class in first column and publish "Yes" in col C (index 2)
          if (cells[0] === classSeperator && cells[2] === "Yes") {
            tableRows.push(cells);
          }
        }
      });

      // Sort by second column (index 1) descending as dates
      tableRows.sort((a, b) => {
        const dateA = new Date(a[1]);
        const dateB = new Date(b[1]);
        return dateB - dateA;
      });

      // Render body
      tableRows.forEach(cells => {
        let newRow = tableBody.insertRow();
        for (let i = 0; i < headerCells.length; i++) {
          if (i !== 2 && i !== 8) { // skip same columns as header
            let newCell = newRow.insertCell();
            if (i === 7) { // column 8 (index 7) becomes a link using col 9 (index 8) for URL
              const link = document.createElement('a');
              link.href = cells[8] || '#';
              link.target = '_blank';
              link.rel = 'noopener noreferrer';
              link.textContent = cells[7] || '';
              newCell.appendChild(link);
            } else {
              newCell.textContent = cells[i] || '';
            }
            if (tableRowColor && /^#[0-9A-Fa-f]{6}$/.test(tableRowColor)) {
              newCell.style.backgroundColor = tableRowColor;
            }
          }
        }

        // Actions cell with toggle button
        const buttonCell = newRow.insertCell();
        const button = document.createElement('button');
        button.textContent = 'Show Details';
        button.classList.add('show-hide-btn');
        buttonCell.appendChild(button);

        // Details row (immediately after)
        let detailsRow = tableBody.insertRow();
        detailsRow.classList.add('details-row');
        detailsRow.style.display = 'none'; // ensure inline state matches CSS
        const detailsCell = detailsRow.insertCell();

        // FIX: colspan should equal number of rendered columns in this row
        detailsCell.colSpan = renderedHeaderCount;

        // Build details HTML (uses cells[3..] as in your original)
        let additionalDetails = `
<table style="margin: 0 auto; border: none; text-align: center;">
  <thead>
    <tr>
      <th style="background-color: transparent; border: none;"></th>
      <th colspan="4" style="margin: 0 auto; border: none; border-right: 1px solid black; border-top: 1px solid black; text-align: center; background-color: lightgray;">
        <h1>${cells[3] || ''}</h1><br>
        <strong>AKS:</strong> ${cells[4] || ''}<br>
      </th>
      <th style="background-color: transparent; border: none;"></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td width="10%" style="background-color: transparent; border: none;"></td>
      <td width="20%" style="background-color: white; border: none; border-left: 1px solid black;"></td>
      <td width="20%" style="background-color: white; border: none;"></td>
      <td width="20%" style="background-color: white; border: none;"></td>
      <td width="20%" style="background-color: white; border: none; border-right: 1px solid black;"></td>
      <td width="10%" style="background-color: transparent; border: none;"></td>
    </tr>

    <tr>
      <td style="background-color: transparent; border: none;"></td>
      <td style="background-color: white; text-align: center; border: none; border-left: 1px solid black;" colspan="2" width="50%">
        <h2><img src="https://jameswhithear.github.io/Whithear_Eclass/Learn%20Icon.png" alt="" title="">&nbsp;Activating Strategy</h2><br>
        ${cells[5] || ''}<br>
      </td>
      <td style="background-color: white; text-align: center; border: none; border-right: 1px solid black;" colspan="2" width="50%">
        <h2><img src="https://jameswhithear.github.io/Whithear_Eclass/Practice%20Icon.png" alt="" title="">&nbsp;Mini-Lesson</h2><br>
        ${cells[6] || ''}<br>
        <a href="${cells[8] || '#'}" target="_blank" rel="noopener noreferrer">${cells[7] || ''}</a><br>
      </td>
      <td style="background-color: transparent; border: none;"></td>
    </tr>

    <tr>
      <td width="10%" style="background-color: transparent; border: none;"></td>
      <td width="20%" style="background-color: white; border: none; border-left: 1px solid black;"></td>
      <td width="20%" style="background-color: white; border: none;"></td>
      <td width="20%" style="background-color: white; border: none;"></td>
      <td width="20%" style="background-color: white; border: none; border-right: 1px solid black;"></td>
      <td width="10%" style="background-color: transparent; border: none;"></td>
    </tr>

    <tr>
      <td style="background-color: transparent; border: none;"></td>
      <td style="background-color: white; border: none; border-left: 1px solid black;"></td>
      <td colspan="2" style="background-color: lightgray; border: none; text-align: center;">
        <h2><img src="https://jameswhithear.github.io/Whithear_Eclass/Show%20Icon.png" alt="" title="">&nbsp;Activating Strategy</h2><br>
        ${cells[9] || ''}<br>
      </td>
      <td style="background-color: white; border: none; border-right: 1px solid black;"></td>
      <td style="background-color: transparent; border: none;"></td>
    </tr>

    <tr>
      <td width="10%" style="background-color: transparent; border: none;"></td>
      <td width="20%" style="background-color: white; border: none; border-left: 1px solid black; border-bottom: 1px solid black;"></td>
      <td width="20%" style="background-color: white; border: none; border-bottom: 1px solid black;"></td>
      <td width="20%" style="background-color: white; border: none; border-bottom: 1px solid black;"></td>
      <td width="20%" style="background-color: white; border: none; border-right: 1px solid black; border-bottom: 1px solid black;"></td>
      <td width="10%" style="background-color: transparent; border: none;"></td>
    </tr>
  </tbody>
</table>
      `;

        detailsCell.innerHTML = additionalDetails.trim();

        // Toggle handler
        button.addEventListener('click', function () {
          const isHidden = detailsRow.style.display === '' || detailsRow.style.display === 'none';
          detailsRow.style.display = isHidden ? 'table-row' : 'none';
          button.textContent = isHidden ? 'Hide Details' : 'Show Details';
        });
      });
    })
    .catch(error => {
      console.error("Error fetching the Google Sheet data:", error);
    });
});
</script>

</body>
</html>

